#!/bin/ksh

if [ `uname` = "Linux" ]; then
	ECHO="echo -e" 
else
	ECHO="echo " 
fi

EGREP="egrep"




help(){
cat  << EOF
########################################################################
# Author      : jigc@cmsz.com
# Script Name : get-month-check-table
# Description : 打印月全量检查报表
# Version     : V1.0
# Usage       : get-month-check-table [--mo|--extract-mode|--restore-mode] 

         --conf 指定配置文件的路径，配置文件格式为 工单编号.conf(OO-20150710-00000001.conf)
		 
         --create-mod    脚本工作在创建更新包的模式下
             
         --extract-mode  脚本工作在更新及备份的模式下(默认仅做备份不做跟新)
             --excute-override 执行更新动作
			 
         --restore-mode  脚本工作在回退的模式下

# Log         :
#  2015.07.15   V1.0: 实现基本功能 
# 
#
# Example     :
#
#  生成更新包：
#    package-utils --create-mode --conf /path/to/conffile/OO-20150710-00000001.conf
#
#  进行备份：
#    package-utils  --extract-mode  --conf /path/to/conffile/KR-20150112-11224364.conf 
#
#  进行备份后再更新:
#    package-utils --extract-mode --excute-override  --conf /path/to/conffile/KR-20150112-11224364.conf 
#
#  回退：
#     package-utils  --restore-mode  --conf /path/to/conffile/KR-20150112-11224364.conf 
#
########################################################################
EOF

}
# 测试用
# | egrep --color "(^\||#[ABC -]#)0022951" 



#获取参数##########################
ARGS=`getopt -a -o m:d:h -l exclude:help -- "$@"`
#[ $? -ne 0 ] && usage
#set -- "${ARGS}"
eval set -- "${ARGS}"
while true
do
    case "$1" in
    -r)
	    SVNLOG="$2"
        shift
        ;;

    -d|--exclude)
        EXCLUDE_PATTERN="^$2$"
        shift
		;;
	-h|--help)
		help | awk  -F"{cmd}[ ]*" \
		'NF==2{printf("%s命令: \033[32m%s\033[0m\n",$1,$2);next};{print}'\
		|  awk  -F"{warn}[ ]*" 'NF==2{printf("%s\033[31m注意: %s\033[0m\n",$1,$2);next};{print}'
		exit 0
		;;
    --)
		until [ -z "$2" ]; do
			[ $(echo "$2" | head -c1) = "-" ] && break
			
			dirName=$(echo "$2" | sed -e 's|/$||g')

			if [ -z "$DIR_LIST" ]; then
				DIR_LIST=$dirName
				DEST_DIR_PATTERN=$DIR_LIST
			else
				mulDir="yes"
				DIR_LIST=$DIR_LIST'|'$dirName;
			fi
			shift
		done
		
		# 多目录处理逻辑
		if [ "$mulDir" = "yes" ]; then
			DEST_DIR_PATTERN="^(${DIR_LIST})/"
		elif [ ! -z "$DEST_DIR_PATTERN" ]; then
			DEST_DIR_PATTERN="^${DIR_LIST}/"
		else 
			DEST_DIR_PATTERN=""
		fi
		
		break
		;;
    esac
shift
done
###################################

getRawResult3Table(){
sqlplus -S /nolog <<EOF
connect ${dbuser}/${dbpwd}@${dbsid}
set feedback off
set heading off
set linesize 1000
set pages 0
set termout off
set null NULL
SELECT 
FCV.BIZ_CODE || FCV.PROVINCE_CODE BIZ_PRIVINCE_CODE,
RET.A_FILE_NAME, RET.B_FILE_NAME, RET.C_FILE_NAME, FCV.COMPARE_TYPE,
TO_CHAR(RET.CREATE_TIME, 'YYYY-MM-DD#HH24:MI:SS'), RET.COMFORM_RATIO,
RET.N1, RET.N2, RET.N3, RET.N4, RET.N5, RET.N6, RET.N7, 
RET.A_REPEAT_RECORD, RET.B_REPEAT_RECORD, RET.C_REPEAT_RECORD,
RET.A_RECORD_TOTAL, RET.B_RECORD_TOTAL, RET.C_RECORD_TOTAL,'RESULT3'
FROM FULL_CONFIG_VIEW FCV LEFT  JOIN MONTH_THREE_FILE_COMPARE RET ON (FCV.BIZ_CODE || FCV.PROVINCE_CODE) = (RET.BIZ_CODE || RET.PROVINCE_CODE)   AND  RET.STTL_DT = '201508'
WHERE COMPARE_WAY = 3  -- and FCV.BIZ_CODE  || FCV.PROVINCE_CODE like '0082%'
ORDER BY FCV.BIZ_CODE || FCV.PROVINCE_CODE
/
EOF
}

getRawResult2Table(){
	return
}


getMonthIncomingTable(){
sqlplus -S /nolog <<EOF
connect ${dbuser}/${dbpwd}@${dbsid}
set feedback off
set heading off
set linesize 1000
set pages 0
SELECT
BIZ_CODE || PROVINCE_CODE BIZ_PRIVINCE_CODE,
FILE_NAME, FILE_SIZE, CKSUM_VALUE, STATE, 
RESEND_NUM, VALIDITY, TO_CHAR(INCOMING_TIME, 'YYYY-MM-DD#HH24:MI:SS'), 'MONTH_INCOMING'
FROM MONTH_INCOMING 
WHERE STTL_DT='201508' -- and BIZ_CODE || PROVINCE_CODE like '0082%'
ORDER BY INCOMING_TIME
/
EOF
}


# 初始化函数
init ()
{
	 . cfConfigFile.sh
	 
	conf_file=${DQAS_HOME}/conf/get-month-check-table.conf
	if [ ! -f ${conf_file} ];then
		echo "conf file [${conf_file}] not exist,exit!"
		exit 1
	fi
	
	# MEARGE_RESULT_IMCOMING_TABLE_AWK=${DQAS_HOME}/bin/merge-result-incoiming-table.awk
	MEARGE_RESULT_IMCOMING_TABLE_AWK=merge-result-incoiming-table.awk
	if [ ! -f ${MEARGE_RESULT_IMCOMING_TABLE_AWK} ];then
		echo "MEARGE_RESULT_IMCOMING_TABLE_AWK file [${MEARGE_RESULT_IMCOMING_TABLE_AWK}] not exist,exit!"
		exit 1
	fi
	cfInit ${conf_file} noLock readOnly
	dbsid=$(cfGetConfigItem common dbsid)
	dbuser=$(cfGetConfigItem common dbuser)
	dbpwd=$(cfGetConfigItem common dbpasswd)
	# dbpwd=`getdbpwd ${dbuser}`
	
	{
		getRawResult3Table
		getMonthIncomingTable
	} | awk -f $MEARGE_RESULT_IMCOMING_TABLE_AWK
	
	# getRawResult3Table
	# getMonthIncomingTable
}
if [ `whoami` = 'root' ];then
	MEARGE_RESULT_IMCOMING_TABLE_AWK=merge-result-incoiming-table.awk
	cat raw.txt | awk -f $MEARGE_RESULT_IMCOMING_TABLE_AWK
else
	init
fi

exit

#main 入口#################################

case "${MODE}" in
	
	"CREATE-MODE")
		create_process
		break
		;;
	"EXTRACT-MODE")
		extract_process
		break
		;;
		
	"RESTORE-MODE")
		restore_process
		break
		;;
	--|*)
		help
		break
		;;
esac
